name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build:
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure macOS signing
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
        run: |
          if [ -n "$APPLE_CERT_BASE64" ]; then
            echo "$APPLE_CERT_BASE64" | base64 --decode > /tmp/apple_cert.p12
            security create-keychain -p "$APPLE_CERT_PASSWORD" build.keychain
            security import /tmp/apple_cert.p12 -k build.keychain -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign
            security list-keychains -s build.keychain
            security unlock-keychain -p "$APPLE_CERT_PASSWORD" build.keychain
            security set-key-partition-list -S apple-tool:,apple: -s -k "$APPLE_CERT_PASSWORD" build.keychain
          fi
          if [ -n "$APPLE_API_KEY_BASE64" ]; then
            echo "$APPLE_API_KEY_BASE64" | base64 --decode > /tmp/apple_api_key.p8
            echo "APPLE_API_KEY=/tmp/apple_api_key.p8" >> "$GITHUB_ENV"
          fi

      - name: Configure Windows signing
        if: matrix.os == 'windows-latest'
        shell: pwsh
        env:
          WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
        run: |
          if (-not [string]::IsNullOrEmpty($env:WIN_CSC_LINK)) {
            $bytes = [System.Convert]::FromBase64String($env:WIN_CSC_LINK)
            $certPath = Join-Path $env:RUNNER_TEMP "windows_cert.pfx"
            [System.IO.File]::WriteAllBytes($certPath, $bytes)
            "CSC_LINK=$certPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          }

      - name: Configure Linux signing
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        env:
          LINUX_GPG_PRIVATE_KEY: ${{ secrets.LINUX_GPG_PRIVATE_KEY }}
          LINUX_GPG_PASSPHRASE: ${{ secrets.LINUX_GPG_PASSPHRASE }}
        run: |
          if [ -n "$LINUX_GPG_PRIVATE_KEY" ]; then
            echo "$LINUX_GPG_PRIVATE_KEY" > /tmp/linux_gpg_private.key
            gpg --batch --import /tmp/linux_gpg_private.key
            echo "GPG signing key imported."
          fi

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test
        continue-on-error: true

      - name: Build application
        env:
          CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
          # Apple API Key auth (APPLE_API_KEY path is set via GITHUB_ENV in configure step)
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER_ID }}
          # Linux signing
          LINUX_GPG_PRIVATE_KEY: ${{ secrets.LINUX_GPG_PRIVATE_KEY }}
          LINUX_GPG_PASSPHRASE: ${{ secrets.LINUX_GPG_PASSPHRASE }}
        run: npm run build

      - name: Upload artifacts (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            release/*.dmg
            release/*.zip
          retention-days: 7

      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            release/*.exe
          retention-days: 7

      - name: Upload artifacts (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
          retention-days: 7
